option_settings:
  aws:elasticbeanstalk:container:nodejs:
    NodeCommand: "npm start"
    ProxyServer: nginx
  aws:elasticbeanstalk:environment:proxy:
    ProxyServer: nginx
  aws:elasticbeanstalk:environment:proxy:staticfiles:
    /static: build/static
  aws:elbv2:loadbalancer:
    IdleTimeout: 4000

files:
  "/etc/nginx/conf.d/01-rate-limits.conf":
    mode: "000644"
    owner: root
    group: root
    content: |
      # Rate limiting zones for TransparAI
      limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;
      limit_req_zone $binary_remote_addr zone=static:10m rate=30r/s;

commands:
  01_backup_nginx:
    command: "cp /etc/nginx/nginx.conf /etc/nginx/nginx.conf.backup || true"
    ignoreErrors: true
  02_ensure_rate_limits:
    command: |
      # Ensure rate limiting zones are defined in main nginx.conf
      if ! grep -q "limit_req_zone.*zone=api" /etc/nginx/nginx.conf; then
        sed -i '/http {/a\    # Rate limiting zones\n    limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;\n    limit_req_zone $binary_remote_addr zone=static:10m rate=30r/s;\n' /etc/nginx/nginx.conf
      fi
  03_nginx_types_hash:
    command: |
      # Fix types_hash configuration
      if ! grep -q "types_hash_max_size" /etc/nginx/nginx.conf; then
        sed -i '/http {/a\    # Types hash settings\n    types_hash_max_size 2048;\n    types_hash_bucket_size 64;\n' /etc/nginx/nginx.conf
      fi